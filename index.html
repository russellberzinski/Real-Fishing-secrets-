<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BestFishingSecrets ‚Äî Feed</title>
  <style>
    :root{
      /* ====== Earth theme ====== */
      --bg:#0b120d;        /* deep forest */
      --card:#121b12;      /* dark moss */
      --text:#f3f1e7;      /* warm parchment */
      --muted:#c9c2aa;     /* dried grass */
      --line:#2c3a2b;      /* pine shadow */
      --accent:#7aa35a;    /* leaf green */
      --accent2:#b08a5a;   /* bark tan */
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:var(--text)}

    /* ====== HERO COLLAGE HEADER ====== */
    .hero-collage{
      position:relative;
      width:100%;
      height:260px;
      overflow:hidden;
      border-bottom:1px solid var(--line);
      background:var(--card);
    }
    .collage-grid{
      height:100%;
      display:grid;
      grid-template-columns:repeat(8,1fr);
    }
    .collage-grid img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      filter:brightness(1.02) saturate(1.02);
      transform:scale(1.02);
    }
    .hero-overlay{
      position:absolute;
      inset:0;
      background:
        radial-gradient(ellipse at center, rgba(11,18,13,.35) 0%, rgba(11,18,13,.78) 70%, rgba(11,18,13,.92) 100%);
      pointer-events:none;
    }
    .hero-text{
      position:absolute;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
      text-align:center;
      padding:0 14px;
      width:min(980px, 100%);
    }
    .hero-text h1{
      margin:0;
      font-size:34px;
      letter-spacing:.2px;
      font-weight:900;
      text-shadow:0 10px 30px rgba(0,0,0,.55);
    }
    .hero-text p{
      margin:8px 0 0;
      color:rgba(243,241,231,.86);
      font-size:14px;
      text-shadow:0 8px 22px rgba(0,0,0,.55);
    }
    .hero-badges{
      margin-top:14px;
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .hero-badge{
      border:1px solid rgba(255,255,255,.16);
      background:rgba(18,27,18,.55);
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
      color:rgba(243,241,231,.9);
      backdrop-filter: blur(6px);
    }

    /* Sticky header below collage */
    header{padding:18px 16px;border-bottom:1px solid var(--line);background:var(--card);position:sticky;top:0;z-index:5}
    h1{margin:0;font-size:18px}

    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .status{padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:var(--card);margin-bottom:12px;color:var(--muted);white-space:pre-wrap}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    button,input,select,textarea{font:inherit}

    button{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(18,27,18,.92), rgba(11,18,13,.92));
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer
    }
    button:hover{filter:brightness(1.08)}
    button:disabled{opacity:.55;cursor:not-allowed}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
    .card{border:1px solid var(--line);border-radius:16px;background:var(--card);padding:14px}
    .title{font-weight:800;margin:0 0 6px;font-size:16px}
    .meta{color:var(--muted);font-size:13px;margin:0 0 10px}

    .price{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(176,138,90,.18);
      font-weight:800
    }

    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}

    .form{
      border:1px solid var(--line);
      border-radius:16px;
      background:var(--card);
      padding:14px;
      margin-bottom:14px;
    }
    .form h2{margin:0 0 10px;font-size:15px}
    .fields{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
    }
    .fields .full{grid-column:1 / -1}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}

    input,select,textarea{
      width:100%;
      border:1px solid var(--line);
      background:#0e1510;
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      outline:none;
    }
    textarea{min-height:90px;resize:vertical}
    .hint{font-size:12px;color:var(--muted);margin-top:8px}
    .ok{color:#bbf7d0}

    .post-img{
      width:100%;
      border-radius:14px;
      border:1px solid var(--line);
      display:block;
      margin:0 0 10px 0;
      background:#0e1510;
    }
    .img-note{font-size:12px;color:var(--muted);margin-top:6px}

    .pill{
      border:1px solid var(--line);
      background:rgba(176,138,90,.14);
      padding:8px 10px;
      border-radius:999px;
      color:var(--muted);
      font-size:12px;
    }

    /* Post instructions box */
    .info-box{
      background: rgba(122,163,90,0.10);
      border: 1px solid rgba(122,163,90,0.40);
      border-radius: 14px;
      padding: 14px 16px;
      margin: 10px 0 14px;
    }
    .info-box h3{
      margin: 0 0 6px;
      font-size: 14px;
      color: var(--text);
      font-weight: 900;
      letter-spacing: .2px;
    }
    .info-box ul{
      margin: 0;
      padding-left: 18px;
      color: var(--muted);
      font-size: 13px;
    }
    .info-box li{
      margin-bottom: 6px;
      line-height: 1.35;
    }
    .info-box li:last-child{margin-bottom:0}

    /* Locked/paid UI */
    .locked{
      border:1px dashed rgba(201,194,170,.35);
      border-radius:14px;
      padding:10px 12px;
      background:rgba(11,18,13,.35);
      margin-top:10px;
    }
    .locked .label{
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }
    .locked .paidContent{
      margin-top:10px;
      padding-top:10px;
      border-top:1px solid rgba(201,194,170,.18);
    }
    .locked .kv{
      margin:0 0 8px 0;
      font-size:13px;
      color:var(--muted);
      word-break:break-word;
    }
    .locked .kv b{color:var(--text)}
    .btn-wide{width:100%}

    @media (max-width:900px){
      .hero-collage{height:220px}
      .collage-grid{grid-template-columns:repeat(4,1fr)}
      .hero-text h1{font-size:30px}
    }
    @media (max-width:720px){
      .fields{grid-template-columns:1fr}
      .hero-collage{height:190px}
      .hero-text h1{font-size:26px}
      .hero-text p{font-size:13px}
    }
  </style>
</head>
<body>
<script>
  var password = prompt("Enter password to access the site:");
  if (password !== "fishing1988") {
    document.body.innerHTML = "";
  }
</script>
  <section class="hero-collage" aria-label="Fishing photo collage">
    <div class="collage-grid" aria-hidden="true">
      <img src="FB_IMG_1770908475493.jpg" alt="">
      <img src="FB_IMG_1770908500189.jpg" alt="">
      <img src="FB_IMG_1770908712570.jpg" alt="">
      <img src="FB_IMG_1770908903224.jpg" alt="">
      <img src="FB_IMG_1770909246382.jpg" alt="">
      <img src="IMG_20250412_132452552_BURST000_COVER~2.jpg" alt="">
      <img src="IMG_20250607_174822729_HDR.jpg" alt="">
      <img src="IMG_20250607_184941296_HDR.jpg" alt="">
    </div>
    <div class="hero-overlay"></div>
    <div class="hero-text">
      <h1>BEST FISHING SECRETS</h1>
      <p>See the catch. Unlock the link + location.</p>
      <div class="hero-badges">
        <span class="hero-badge"> üé£ Photo preview is free</span>
        <span class="hero-badge">üîè Sign-in to post</span>
        <span class="hero-badge">üí≥üîì Link + location are paid</span>
      </div>
    </div>
  </section>

  <header><h1>BestFishingSecrets ‚Äî Live Feed</h1></header>

  <div class="wrap">
    <div id="status" class="status">Loading‚Ä¶</div>

    <div class="row" style="margin-top:8px">
      <span class="pill">üÜì Free: title + state + photo</span>
      <span class="pill">üí≥ Paid unlock: full link + secret location</span>
      <span class="pill">üîè Sign-in required to post</span>
    </div>

    <div class="form">
      <h2>Browse</h2>
      <div class="fields">
        <div class="full">
          <label for="filterState">Filter by state (optional)</label>
          <select id="filterState">
            <option value="">All states</option>
            <option>Alabama</option><option>Alaska</option><option>Arizona</option><option>Arkansas</option>
            <option>California</option><option>Colorado</option><option>Connecticut</option><option>Delaware</option>
            <option>Florida</option><option>Georgia</option><option>Hawaii</option><option>Idaho</option>
            <option>Illinois</option><option>Indiana</option><option>Iowa</option><option>Kansas</option>
            <option>Kentucky</option><option>Louisiana</option><option>Maine</option><option>Maryland</option>
            <option>Massachusetts</option><option>Michigan</option><option>Minnesota</option><option>Mississippi</option>
            <option>Missouri</option><option>Montana</option><option>Nebraska</option><option>Nevada</option>
            <option>New Hampshire</option><option>New Jersey</option><option>New Mexico</option><option>New York</option>
            <option>North Carolina</option><option>North Dakota</option><option>Ohio</option><option>Oklahoma</option>
            <option>Oregon</option><option>Pennsylvania</option><option>Rhode Island</option><option>South Carolina</option>
            <option>South Dakota</option><option>Tennessee</option><option>Texas</option><option>Utah</option>
            <option>Vermont</option><option>Virginia</option><option>Washington</option><option>West Virginia</option>
            <option>Wisconsin</option><option>Wyoming</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="reloadBtn" type="button">Reload posts</button>
      </div>
      <div class="hint">Tip: choose a state to filter, then tap ‚ÄúReload posts‚Äù.</div>
    </div>

    <div class="form">
      <h2>Post a Catch</h2>

      <div class="info-box">
        <h3>What buyers get</h3>
        <ul>
          <li><strong>Free preview:</strong> Title + state + photo only.</li>
          <li><strong>Paid unlock:</strong> Full link + secret location.</li>
          <li><strong>Important:</strong> Full link and secret location are saved in a private collection (not shown on the public feed).</li>
        </ul>
      </div>

      <div class="fields">
        <div>
          <label for="title">Title</label>
          <input id="title" placeholder="e.g., 5lb bass at dawn" />
        </div>

        <div>
          <label for="state">State</label>
          <select id="state">
            <option value="">Select a state‚Ä¶</option>
            <option>Alabama</option><option>Alaska</option><option>Arizona</option><option>Arkansas</option>
            <option>California</option><option>Colorado</option><option>Connecticut</option><option>Delaware</option>
            <option>Florida</option><option>Georgia</option><option>Hawaii</option><option>Idaho</option>
            <option>Illinois</option><option>Indiana</option><option>Iowa</option><option>Kansas</option>
            <option>Kentucky</option><option>Louisiana</option><option>Maine</option><option>Maryland</option>
            <option>Massachusetts</option><option>Michigan</option><option>Minnesota</option><option>Mississippi</option>
            <option>Missouri</option><option>Montana</option><option>Nebraska</option><option>Nevada</option>
            <option>New Hampshire</option><option>New Jersey</option><option>New Mexico</option><option>New York</option>
            <option>North Carolina</option><option>North Dakota</option><option>Ohio</option><option>Oklahoma</option>
            <option>Oregon</option><option>Pennsylvania</option><option>Rhode Island</option><option>South Carolina</option>
            <option>South Dakota</option><option>Tennessee</option><option>Texas</option><option>Utah</option>
            <option>Vermont</option><option>Virginia</option><option>Washington</option><option>West Virginia</option>
            <option>Wisconsin</option><option>Wyoming</option>
          </select>
        </div>

        <div>
          <label for="price">Price (USD)</label>
          <input id="price" type="number" step="0.01" min="0" placeholder="9.99" />
        </div>

        <div class="full">
          <label for="paidLink">Full link (PAID ‚Äî unlocked after purchase)</label>
          <input id="paidLink" placeholder="https://..." />
          <div class="hint">This will NOT be shown publicly. Buyers unlock it.</div>
        </div>

        <div class="full">
          <label for="photo">Photo (uploaded to Cloudinary) ‚Äî FREE teaser</label>
          <input id="photo" type="file" accept="image/*" />
          <div class="img-note">Recommended. Large files may take longer on mobile.</div>
        </div>

        <div class="full">
          <label for="secretLocation">Secret location (PAID ‚Äî stored privately)</label>
          <textarea id="secretLocation" placeholder="Example: Lake name, GPS pin, access details‚Ä¶"></textarea>
          <div class="hint">Saved privately. Only buyers should see it after payment verification.</div>
          <div class="hint" style="margin-top:6px;">
            Locked content must include a secondary photo or video showing a recognizable structure,
            landmark, or environmental feature near the fishing location.
          </div>
        </div>

        <div class="full" style="margin-top:6px;">
          <label style="display:flex;gap:8px;align-items:flex-start;">
            <input type="checkbox" id="honestyCheck" />
            <span style="font-size:13px;color:var(--muted);">
              I confirm this post contains truthful location information and includes
              a recognizable structure or landmark in the locked proof photo or video.
            </span>
          </label>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="postBtn" disabled>Sign in to post</button>
      </div>
      <div id="postHint" class="hint">You can browse without signing in. Sign in only if you want to post.</div>
    </div>

    <div id="grid" class="grid"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      addDoc,
      setDoc,
      getDoc,
      doc,
      serverTimestamp,
      query,
      orderBy,
      where
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      signInWithRedirect,
      getRedirectResult,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    const statusEl = document.getElementById("status");
    const gridEl = document.getElementById("grid");
    const filterStateEl = document.getElementById("filterState");

    const titleEl = document.getElementById("title");
    const stateEl = document.getElementById("state");
    const priceEl = document.getElementById("price");
    const paidLinkEl = document.getElementById("paidLink");
    const secretLocationEl = document.getElementById("secretLocation");
    const photoEl = document.getElementById("photo");
    const honestyCheckEl = document.getElementById("honestyCheck");

    const postBtn = document.getElementById("postBtn");
    const reloadBtn = document.getElementById("reloadBtn");
    const postHintEl = document.getElementById("postHint");

    window.addEventListener("unhandledrejection", (e) => {
      statusEl.textContent = "‚ùå Unhandled promise:\n" + (e.reason?.message || e.reason || e);
    });
    window.addEventListener("error", (e) => {
      statusEl.textContent = "‚ùå JS error:\n" + (e.message || e);
    });

    const CLOUDINARY_CLOUD_NAME = "dhuakqubc";
    const CLOUDINARY_UPLOAD_PRESET = "emiktt1b";
    const CLOUDINARY_UPLOAD_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;

    const firebaseConfig = {
      apiKey: "AIzaSyCndtMlIb_Y_YCP1RO-ctfizRU6q1MGeHY",
      authDomain: "bestfishingsecrets-932cf.firebaseapp.com",
      projectId: "bestfishingsecrets-932cf",
      storageBucket: "bestfishingsecrets-932cf.firebasestorage.app",
      messagingSenderId: "387299114354",
      appId: "1:387299114354:web:cbadda074f9dd7083ef1eb",
      measurementId: "G-Z8L28MXNEG"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const authRow = document.createElement("div");
    authRow.className = "row";
    authRow.innerHTML = `
      <button id="loginBtn" type="button">Sign in with Google</button>
      <button id="logoutBtn" type="button" style="display:none">Sign out</button>
      <span id="userInfo" class="meta"></span>
    `;
    statusEl.insertAdjacentElement("afterend", authRow);

    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const userInfo = document.getElementById("userInfo");

    let currentUser = null;

    onAuthStateChanged(auth, (user) => {
      currentUser = user;

      if (user) {
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        userInfo.textContent = `Signed in as ${user.displayName || user.email || "User"}`;
        postBtn.disabled = false;
        postBtn.textContent = "Post catch";
        postHintEl.textContent = "‚úÖ You‚Äôre signed in ‚Äî you can post now.";
        postHintEl.classList.add("ok");
      } else {
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        userInfo.textContent = "Not signed in";
        postBtn.disabled = true;
        postBtn.textContent = "Sign in to post";
        postHintEl.textContent = "You can browse without signing in. Sign in only if you want to post.";
        postHintEl.classList.remove("ok");
      }
    });

    try{
      await getRedirectResult(auth);
    }catch(err){
      statusEl.textContent = "‚ö†Ô∏è Redirect sign-in error:\n" + (err?.message || String(err));
    }

    loginBtn.addEventListener("click", async () => {
      statusEl.textContent = "Signing in‚Ä¶";
      try {
        await signInWithPopup(auth, provider);
        statusEl.textContent = "‚úÖ Signed in.";
      } catch (e) {
        const msg = (e?.message || "").toLowerCase();
        const code = (e?.code || "").toLowerCase();
        const looksLikePopupBlocked =
          code.includes("popup") || msg.includes("popup") || msg.includes("blocked") || msg.includes("closed");

        if (looksLikePopupBlocked) {
          statusEl.textContent = "Popup blocked. Switching to redirect sign-in‚Ä¶";
          await signInWithRedirect(auth, provider);
          return;
        }

        statusEl.textContent = "‚ùå Sign-in failed:\n" + (e?.message || String(e));
      }
    });

    logoutBtn.addEventListener("click", async () => {
      try {
        await signOut(auth);
        statusEl.textContent = "Signed out.";
      } catch (e) {
        statusEl.textContent = "‚ùå Sign-out failed:\n" + (e?.message || String(e));
      }
    });

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function isValidUrl(s){
      if (!s) return false;
      try { new URL(s); return true; } catch { return false; }
    }

    // ======= IMPORTANT: PAYWALL NOTE =======
    // The public feed must NOT read paidLink/secretLocation directly.
    // This page assumes paid info lives in a private doc: postSecrets/{postId}
    // and your Firestore Rules + (eventually) Stripe verification decide who can read it.
    //
    // For now, this UI provides an "Unlock" button and will attempt to read postSecrets/{postId}.
    // If your rules block it (as they should), it will show a clear "locked" message.
    // Once you add Stripe + server verification, you'll switch unlock flow to call your server,
    // then write an unlock record, then allow reading postSecrets.

    function cardHTML(p){
      const title = p.title ?? "Untitled catch";
      const state = p.state ?? "Unknown";
      const priceRaw = p.price;
      const price = (typeof priceRaw === "number") ? priceRaw.toFixed(2) : (priceRaw ?? "‚Äî");
      const imageUrl = p.imageUrl ?? "";

      const hasPaid = !!p.hasPaid; // indicates this post has paid content stored privately

      return `
        <div class="card" data-postid="${escapeHtml(p.id)}">
          ${imageUrl ? `<img class="post-img" src="${escapeHtml(imageUrl)}" alt="Catch photo" loading="lazy" />` : ""}
          <p class="title">${escapeHtml(title)}</p>
          <p class="meta">State: <b>${escapeHtml(state)}</b></p>
          <p class="meta"><span class="price">$${escapeHtml(price)}</span></p>

          ${hasPaid ? `
            <div class="locked">
              <div class="label">Paid content</div>
              <button class="btn-wide unlockBtn" type="button" data-postid="${escapeHtml(p.id)}">
                Unlock link + location
              </button>

              <div class="paidContent" style="display:none">
                <p class="kv"><b>Full link:</b> <a class="paidLink" href="#" target="_blank" rel="noopener">Open</a></p>
                <p class="kv"><b>Secret location:</b> <span class="secretLoc"></span></p>
              </div>

              <div class="hint" style="margin-top:8px;">
                If you can‚Äôt unlock yet, payments/verification may not be enabled on this build.
              </div>
            </div>
          ` : `
            <div class="hint">No paid link/location attached to this post.</div>
          `}
        </div>
      `;
    }

    async function uploadToCloudinary(file){
      const maxMB = 12;
      const sizeMB = file.size / (1024*1024);
      if (sizeMB > maxMB) throw new Error(`Image too large (${sizeMB.toFixed(1)}MB). Choose under ${maxMB}MB.`);
      if (!file.type.startsWith("image/")) throw new Error("Selected file is not an image.");

      const fd = new FormData();
      fd.append("file", file);
      fd.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);

      const res = await fetch(CLOUDINARY_UPLOAD_URL, { method: "POST", body: fd });
      if (!res.ok) {
        const text = await res.text().catch(() => "");
        throw new Error(`Cloudinary upload failed (${res.status}). ${text}`);
      }
      return await res.json();
    }

    async function loadPosts(){
      gridEl.innerHTML = "";
      statusEl.textContent = "Loading posts‚Ä¶";

      const chosenState = filterStateEl.value.trim();

      try{
        let snap;
        try{
          const base = collection(db, "posts");
          const q = chosenState
            ? query(base, where("state", "==", chosenState), orderBy("createdAt", "desc"))
            : query(base, orderBy("createdAt", "desc"));
          snap = await getDocs(q);
        }catch(e){
          snap = await getDocs(collection(db, "posts"));
        }

        if (!snap || snap.empty){
          statusEl.textContent = chosenState
            ? `No posts found for ${chosenState} yet.`
            : "No posts yet. Sign in if you want to post the first one.";
          return;
        }

        let posts = [];
        snap.forEach(d => posts.push({ id: d.id, ...d.data() }));

        if (chosenState) posts = posts.filter(p => (p.state || "").trim() === chosenState);

        if (!posts.length) {
          statusEl.textContent = `No posts found for ${chosenState} yet.`;
          return;
        }

        let html = "";
        for (const p of posts) html += cardHTML(p);
        gridEl.innerHTML = html;

        statusEl.textContent = chosenState
          ? `Loaded ${posts.length} post(s) for ${chosenState}.`
          : `Loaded ${posts.length} post(s).`;
      }catch(err){
        statusEl.textContent =
          "‚ùå Error loading posts.\n\nMost common causes:\n- Firestore Rules blocking reads\n- Firestore not created\n- Network/adblock\n\nDetails:\n" + (err?.message || String(err));
      }
    }

    function showPaidInCard(postId, paidLink, secretLocation){
      const card = gridEl.querySelector(`.card[data-postid="${CSS.escape(postId)}"]`);
      if (!card) return;

      const paid = card.querySelector(".paidContent");
      const a = card.querySelector(".paidLink");
      const loc = card.querySelector(".secretLoc");
      const btn = card.querySelector(".unlockBtn");

      a.href = paidLink;
      a.textContent = paidLink;
      loc.textContent = secretLocation;

      paid.style.display = "block";
      if (btn) btn.style.display = "none";
    }

    // Placeholder unlock: tries to read postSecrets/{postId}
    // In the ‚Äúreal‚Äù Stripe version, you should:
    // 1) create Stripe checkout session on server
    // 2) after payment webhook, write users/{uid}/unlocks/{postId}
    // 3) rules allow reading postSecrets only if unlock exists
    async function unlockPaid(postId){
      statusEl.textContent = "Unlocking‚Ä¶";

      try{
        const secretRef = doc(db, "postSecrets", postId);
        const snap = await getDoc(secretRef);

        if (!snap.exists()){
          statusEl.textContent = "‚ùå Locked content not found for this post.";
          return;
        }

        const data = snap.data() || {};
        const paidLink = (data.paidLink || "").trim();
        const secretLocation = (data.secretLocation || "").trim();

        if (!paidLink || !secretLocation){
          statusEl.textContent = "‚ùå Locked content is incomplete (missing link or location).";
          return;
        }

        showPaidInCard(postId, paidLink, secretLocation);
        statusEl.textContent = "‚úÖ Unlocked (demo). If this should be paid, add Stripe verification + rules gating.";
      }catch(err){
        statusEl.textContent =
          "üîí Still locked.\n\nThis is expected until you enable payment verification + Firestore Rules.\n\nDetails:\n" +
          (err?.message || String(err));
      }
    }

    // Event delegation for unlock buttons
    gridEl.addEventListener("click", (e) => {
      const btn = e.target.closest(".unlockBtn");
      if (!btn) return;
      const postId = btn.getAttribute("data-postid");
      if (!postId) return;
      unlockPaid(postId);
    });

    async function postCatch(){
      if (!currentUser) {
        statusEl.textContent = "‚ùå Please sign in first to post.";
        return;
      }

      const title = titleEl.value.trim();
      const state = stateEl.value.trim();
      const priceStr = priceEl.value.trim();
      const paidLink = paidLinkEl.value.trim();
      const secretLocation = secretLocationEl.value.trim();

      if (!title) { statusEl.textContent = "‚ùå Please enter a title."; return; }
      if (!state) { statusEl.textContent = "‚ùå Please select a state."; return; }
      if (priceStr === "" || Number.isNaN(Number(priceStr))) { statusEl.textContent = "‚ùå Please enter a valid price."; return; }
      if (!isValidUrl(paidLink)) { statusEl.textContent = "‚ùå Please enter a valid Full link (https://...)."; return; }
      if (!secretLocation) { statusEl.textContent = "‚ùå Please enter a secret location (paid content)."; return; }

      if (!honestyCheckEl.checked) {
        statusEl.textContent = "‚ùå You must confirm the honesty agreement before posting.";
        return;
      }

      postBtn.disabled = true;

      let imageUrl = null;
      let imagePublicId = null;

      try{
        const file = photoEl.files && photoEl.files[0] ? photoEl.files[0] : null;
        if (file) {
          statusEl.textContent = "Uploading photo‚Ä¶";
          const uploaded = await uploadToCloudinary(file);
          imageUrl = uploaded.secure_url || uploaded.url || null;
          imagePublicId = uploaded.public_id || null;
          if (!imageUrl) throw new Error("Upload succeeded but no image URL was returned.");
        } else {
          statusEl.textContent = "‚ùå Please upload a photo (this is the free teaser).";
          return;
        }

        statusEl.textContent = "Posting‚Ä¶";

        // PUBLIC: only title + state + photo (+ price)
        const postRef = await addDoc(collection(db, "posts"), {
          title,
          state,
          price: Number(priceStr),

          imageUrl: imageUrl,
          imagePublicId: imagePublicId,

          hasPaid: true,

          userId: currentUser.uid,
          userName: currentUser.displayName || null,
          userEmail: currentUser.email || null,
          createdAt: serverTimestamp()
        });

        // PRIVATE: paid link + secret location
        await setDoc(doc(db, "postSecrets", postRef.id), {
          postId: postRef.id,
          ownerId: currentUser.uid,
          paidLink: paidLink,
          secretLocation: secretLocation,
          createdAt: serverTimestamp()
        });

        titleEl.value = "";
        stateEl.value = "";
        priceEl.value = "";
        paidLinkEl.value = "";
        secretLocationEl.value = "";
        photoEl.value = "";
        honestyCheckEl.checked = false;

        statusEl.textContent = "‚úÖ Posted!";
        await loadPosts();
      }catch(err){
        statusEl.textContent = "‚ùå Post failed.\n\nDetails:\n" + (err?.message || String(err));
      }finally{
        postBtn.disabled = !currentUser;
      }
    }

    postBtn.addEventListener("click", postCatch);
    reloadBtn.addEventListener("click", loadPosts);
    filterStateEl.addEventListener("change", loadPosts);

    await loadPosts();
  </script>
</body>
</html>
